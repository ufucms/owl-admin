<?php

namespace Slowlyo\OwlAdmin\Console;

use Illuminate\Console\Command;
use Slowlyo\OwlAdmin\Services\AdminCodeGeneratorService;

class GenRouteCommand extends Command
{
    protected $signature = 'admin:gen-route {--excluded=}';

    protected $description = 'Generate admin route file.';

    public function handle(): void
    {
        $content = <<<EOF
<?php

// Route file auto generated by owl-admin, don't modify it manually.

use Slowlyo\OwlAdmin\Admin;
use Illuminate\Routing\Router;
use Illuminate\Support\Facades\Route;

Route::group([
    'domain'     => Admin::config('admin.route.domain'),
    'prefix'     => Admin::config('admin.route.prefix'),
    'middleware' => Admin::config('admin.route.middleware'),
], function (Router \$router) {
_content_
});
EOF;


        $excluded = $this->option('excluded');
        if ($excluded) {
            $excluded = explode(',', $excluded);
        }

        $routes = '';
        AdminCodeGeneratorService::make()
            ->getModel()
            ->query()
            ->when($excluded, fn($query, $excluded) => $query->whereNotIn('id', $excluded))
            ->get()
            ->map(function ($item) use (&$routes) {
                if (!$item->menu_info['enabled']) return;

                $_route      = ltrim($item->menu_info['route'], '/');
                $_controller = '\\' . str_replace('/', '\\', $item->controller_name);

                $routes .= <<<EOF
    // {$item->title}
    \$router->resource('{$_route}', {$_controller}::class);

EOF;

            });

        $content = str_replace('_content_', $routes, $content);

        file_put_contents(base_path('routes/admin.php'), $content);

        $this->info('Route file generated successfully.');
    }
}
